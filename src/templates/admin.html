{% extends "base.html" %}
{% block content %}
  <!-- Import map for proper module resolution -->
  <script type="importmap">
  {
    "imports": {
      "@lit/reactive-element": "https://cdn.jsdelivr.net/npm/@lit/reactive-element@1.6.3/reactive-element.js",
      "lit": "https://cdn.jsdelivr.net/gh/lit/dist@3/all/lit-all.min.js",
      "lit-element": "https://cdn.jsdelivr.net/gh/lit/dist@3/all/lit-all.min.js",
      "lit-html": "https://cdn.jsdelivr.net/gh/lit/dist@3/all/lit-all.min.js",
      "lit-element/lit-element.js": "https://cdn.jsdelivr.net/gh/lit/dist@3/all/lit-all.min.js",
      "lit-html/lit-html.js": "https://cdn.jsdelivr.net/gh/lit/dist@3/all/lit-all.min.js",
      "lit-html/is-server.js": "/static/assets/scripts/is-server.js",
      "chart.js/auto": "https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.js",
      "chart.js": "https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.js"
    }
  }
  </script>
  
  <!-- Import map polyfill for older browsers -->
  <script async src="https://ga.jspm.io/npm:es-module-shims@1.7.3/dist/es-module-shims.js"></script>
  
  <!-- WebAwesome CDN loading -->
  <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-alpha.12/dist/styles/themes/default.css" />
  <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-alpha.12/dist/styles/webawesome.css" />
  <script type="module" src="https://early.webawesome.com/webawesome@3.0.0-alpha.12/dist/webawesome.loader.js"></script>

  <!-- Module fallback system for handling bare module specifiers (backup) -->
  <script type="module" src="/static/assets/scripts/module-fallback.js"></script>
  
  <!-- Dynamic import handler for better module resolution -->
  <script type="module" src="/static/assets/scripts/dynamic-import-handler.js"></script>
  
  <!-- Load Lit from CDN - unified bundle that has everything -->
  <script type="module">
    // Load the complete Lit bundle that has everything
    import * as lit from 'https://cdn.jsdelivr.net/gh/lit/dist@3/all/lit-all.min.js';
    
    // Make it available globally for all components
    window.lit = lit;
    window.LitElement = lit.LitElement;
    window.html = lit.html;
    window.css = lit.css;
    window.repeat = lit.repeat;
    window.choose = lit.choose;
    window.guard = lit.guard;
    window.cache = lit.cache;
    window.classMap = lit.classMap;
    window.styleMap = lit.styleMap;
    window.nothing = lit.nothing;
    window.ReactiveElement = lit.ReactiveElement;
    
    // Also preload Chart.js to avoid import errors
    import('https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.js')
      .then(module => {
        window.Chart = module.Chart;
        console.log('Chart.js loaded and globally available');
      })
      .catch(err => console.error('Failed to preload Chart.js:', err));
    
    console.log('Lit bundle loaded and globally available');
  </script>
  
  <!-- Load Shoelace CDN components -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/light.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/themes/dark.css" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.12.0/cdn/shoelace.js"></script>
  
  <!-- Load Chart.js loader script -->
  <script src="/static/assets/scripts/chart-loader.js"></script>
  
  <!-- Chart.js for data visualization - load as a global script -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.js"></script>
  
  <!-- Load our component scripts with the new naming convention -->
  <!-- Load all components through the main index file -->
  <script type="module" src="/static/components/index.js"></script>
  
  <!-- Directly load the app shell and admin dashboard for immediate display -->
  <script type="module" src="/static/components/okui-app-shell.js"></script>
  <script type="module" src="/static/components/admin/okui-admin-dashboard.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: var(--sl-font-sans);
      background-color: var(--sl-color-neutral-50);
      color: var(--sl-color-neutral-900);
    }
    
    .sl-theme-dark {
      background-color: var(--sl-color-neutral-900);
      color: var(--sl-color-neutral-100);
    }
    
    /* Fix for Shoelace focus outline styles */
    :focus-visible {
      outline: 2px solid var(--sl-color-primary-600);
      outline-offset: 2px;
    }
    
    .admin-container {
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .admin-component-container {
      flex: 1;
      padding: 20px;
    }
  </style>
  
  <!-- Define component paths for dynamic loading -->
  <script>
    // Map component names to their module paths for dynamic loading
    window.componentModuleMap = {
      // Main index file that loads everything
      'main': '/static/components/index.js',
      
      // Module index files
      'admin-module': '/static/components/admin/index.js',
      'app-module': '/static/components/app/index.js',
      'attributes-module': '/static/components/attributes/index.js',
      'authorization-module': '/static/components/authorization/index.js',
      'base-module': '/static/components/base/index.js',
      'detail-module': '/static/components/detail/index.js',
      'dialogs-module': '/static/components/dialogs/index.js',
      'forms-module': '/static/components/forms/index.js',
      'generic-module': '/static/components/generic/index.js',
      'jobs-module': '/static/components/jobs/index.js',
      'list-module': '/static/components/list/index.js',
      'monitoring-module': '/static/components/monitoring/index.js',
      'queries-module': '/static/components/queries/index.js',
      'reports-module': '/static/components/reports/index.js',
      'security-module': '/static/components/security/index.js',
      'utilities-module': '/static/components/utilities/index.js',
      'values-module': '/static/components/values/index.js',
      'vector-search-module': '/static/components/vector-search/index.js',
      'workflows-module': '/static/components/workflows/index.js',
      
      // Core components
      'okui-app-shell': '/static/components/okui-app-shell.js',
      'okui-admin-dashboard': '/static/components/admin/okui-admin-dashboard.js',
      
      // Workflow components (new OKUI versions)
      'okui-workflow-dashboard': '/static/components/workflows/okui-workflow-dashboard.js',
      'okui-workflow-designer': '/static/components/workflows/okui-workflow-designer.js',
      'okui-workflow-execution-detail': '/static/components/workflows/okui-workflow-execution-detail.js',
      'okui-workflow-simulator': '/static/components/workflows/okui-workflow-simulator.js',
      
      // Legacy components (WebAwesome naming)
      'wa-attributes-manager': '/static/components/attributes/wa-attributes-manager.js',
      'wa-values-manager': '/static/components/values/wa-values-manager.js',
      'wa-queries-manager': '/static/components/queries/wa-queries-manager.js',
      'wa-job-dashboard': '/static/components/jobs/wa-job-dashboard.js',
      'wa-security-admin': '/static/components/security/wa-security-admin.js',
      'wa-report-dashboard': '/static/components/reports/report-dashboard.js',
      'wa-semantic-search': '/static/components/vector-search/wa-semantic-search.js',
      'wa-role-manager': '/static/components/authorization/wa-role-manager.js',
      'wa-system-monitor': '/static/components/monitoring/wa-system-monitor.js',
      'wa-crud-manager': '/static/components/generic/wa-crud-manager.js',
      'wa-crud-example': '/static/components/generic/wa-crud-example.js',
      
      // Component name mapping (for compatibility with both naming conventions)
      'okui-attributes-manager': '/static/components/attributes/wa-attributes-manager.js',
      'okui-values-manager': '/static/components/values/wa-values-manager.js',
      'okui-queries-manager': '/static/components/queries/wa-queries-manager.js',
      'okui-job-dashboard': '/static/components/jobs/wa-job-dashboard.js',
      'okui-security-admin': '/static/components/security/wa-security-admin.js',
      'okui-report-dashboard': '/static/components/reports/report-dashboard.js',
      'okui-reports-dashboard': '/static/components/reports/report-dashboard.js', // Special mapping for plural URL
      'okui-semantic-search': '/static/components/vector-search/wa-semantic-search.js',
      'okui-vector-search-dashboard': '/static/components/vector-search/wa-semantic-search.js', // Special mapping for URL
      'okui-role-manager': '/static/components/authorization/wa-role-manager.js',
      'okui-system-monitor': '/static/components/monitoring/wa-system-monitor.js',
      'okui-crud-manager': '/static/components/generic/wa-crud-manager.js',
      'okui-crud-example': '/static/components/generic/wa-crud-example.js'
    };
    
    // Function to load component dynamically if not already registered
    async function ensureComponentLoaded(tagName) {
      tagName = tagName.toLowerCase();
      
      // Skip if component is already defined
      if (customElements.get(tagName)) {
        console.log(`Component ${tagName} is already registered.`);
        return Promise.resolve();
      }
      
      // Determine which module might contain this component
      const moduleMap = {
        'wa-attributes-manager': 'attributes-module',
        'okui-attributes-manager': 'attributes-module',
        'wa-values-manager': 'values-module',
        'okui-values-manager': 'values-module',
        'wa-queries-manager': 'queries-module',
        'okui-queries-manager': 'queries-module',
        'wa-job-dashboard': 'jobs-module',
        'okui-job-dashboard': 'jobs-module',
        'wa-security-admin': 'security-module',
        'okui-security-admin': 'security-module',
        'wa-report-dashboard': 'reports-module',
        'okui-report-dashboard': 'reports-module',
        'okui-reports-dashboard': 'reports-module', // Added for plural URL support
        'wa-semantic-search': 'vector-search-module',
        'okui-semantic-search': 'vector-search-module',
        'okui-vector-search-dashboard': 'vector-search-module', // Added for URL support
        'wa-role-manager': 'authorization-module',
        'okui-role-manager': 'authorization-module',
        'wa-system-monitor': 'monitoring-module',
        'okui-system-monitor': 'monitoring-module',
        'okui-workflow-dashboard': 'workflows-module',
        'okui-workflow-designer': 'workflows-module',
        'okui-workflow-execution-detail': 'workflows-module',
        'okui-workflow-simulator': 'workflows-module',
        'okui-app-shell': 'app-module',
        'okui-admin-dashboard': 'admin-module',
        'wa-crud-manager': 'generic-module',
        'wa-crud-example': 'generic-module',
        'okui-crud-manager': 'generic-module',
        'okui-crud-example': 'generic-module'
      };
      
      try {
        // First try to load the entire module if we can identify it
        const potentialModule = moduleMap[tagName];
        if (potentialModule && window.componentModuleMap[potentialModule]) {
          console.log(`Loading module ${potentialModule} for component ${tagName}`);
          await import(window.componentModuleMap[potentialModule]);
        }
        
        // Then try to load the specific component
        if (window.componentModuleMap[tagName]) {
          console.log(`Loading specific component ${tagName}`);
          await import(window.componentModuleMap[tagName]);
          console.log(`Dynamically loaded component: ${tagName}`);
          return Promise.resolve();
        }
        
        // If no direct mapping is found, try loading the main index as a last resort
        if (!customElements.get(tagName)) {
          console.log(`Component still not loaded, attempting to load main index`);
          await import(window.componentModuleMap['main']);
          
          if (customElements.get(tagName)) {
            console.log(`Component ${tagName} successfully loaded via main index`);
            return Promise.resolve();
          } else {
            console.warn(`Component ${tagName} not found after loading all modules`);
            return Promise.reject(new Error(`Component ${tagName} not registered or available`));
          }
        }
        
        return Promise.resolve();
      } catch (error) {
        console.error(`Failed to load component ${tagName}:`, error);
        return Promise.reject(error);
      }
    }
  </script>
  
  <div class="admin-container">
    <!-- Use App Shell for navigation and global UI -->
    <okui-app-shell site-name="{{ site_name }}">
      <div class="admin-component-container" id="component-container">
        <!-- The dynamic component will be inserted here -->
        {% if component %}
          <div id="component-placeholder" data-component="{{ component }}"
            {% if props %}
              {% for key, value in props.items() %}
                data-{{ key }}="{{ value }}"
              {% endfor %}
            {% endif %}
          >
            <div style="padding: 40px; text-align: center; color: #666;">
              Loading component...
            </div>
          </div>
        {% else %}
          <okui-admin-dashboard></okui-admin-dashboard>
        {% endif %}
      </div>
    </okui-app-shell>
  </div>
  
  <!-- Script for dynamic component instantiation -->
  <script>
    // Initialize component function - define this first
    const initializeComponent = async () => {
      console.log("DOM Content Loaded, initializing component...");
      const placeholder = document.getElementById('component-placeholder');
      
      // If placeholder doesn't exist, check if we need to load a component
      if (!placeholder) {
        console.log("No placeholder found, checking URL for component");
        const container = document.getElementById('component-container');
        if (!container) {
          console.error("Component container not found!");
          return;
        }
        
        // Check URL to see if we need to load a component
        const urlPath = window.location.pathname;
        if (urlPath.includes('/admin/')) {
          const pathParts = urlPath.split('/');
          const componentName = pathParts[pathParts.length - 1];
          if (componentName && componentName !== 'admin') {
            console.log(`Loading component from URL path: ${componentName}`);
            try {
              // Define loadComponentByName function with robust error handling
              const loadComponentByName = async (tagName, container) => {
                try {
                  // First try to ensure the component is loaded
                  await ensureComponentLoaded(tagName);
                  
                  // Verify component is actually registered before creating element
                  if (!customElements.get(tagName)) {
                    console.warn(`Component ${tagName} not registered after loading, might be a registration issue`);
                    throw new Error(`Component ${tagName} not registered after loading attempt`);
                  }
                  
                  // Create and append the component
                  const component = document.createElement(tagName);
                  container.innerHTML = '';
                  container.appendChild(component);
                  console.log(`Component ${tagName} loaded from URL`);
                  
                  // Add a safety check to make sure component initialized properly
                  setTimeout(() => {
                    if (component && !component.shadowRoot && !component.innerHTML) {
                      console.warn(`Component ${tagName} may not have initialized properly`);
                    }
                  }, 1000);
                } catch (err) {
                  console.error(`Error in loadComponentByName for ${tagName}:`, err);
                  throw err; // Re-throw to be handled by the caller
                }
              };
              
              // Try to handle plural/singular names (e.g., "reports" vs "report")
              // For example, handle both /admin/reports and /admin/report
              const singularName = componentName.endsWith('s') 
                ? componentName.slice(0, -1) 
                : componentName;
                
              // List of possible component naming patterns to try
              const namesToTry = [
                `okui-${componentName}-dashboard`,     // First try exact match
                `okui-${singularName}-dashboard`,      // Try singular version
                `wa-${componentName}-dashboard`,       // Try wa- prefix
                `wa-${singularName}-dashboard`,        // Try wa- prefix with singular
                `wa-${componentName}-manager`,         // Try manager suffix
                `wa-${singularName}-manager`,          // Try manager suffix with singular
                `${componentName}-dashboard`,          // Try without prefix
                `${singularName}-dashboard`,           // Try without prefix with singular
              ];
              
              console.log(`Trying these component names: ${namesToTry.join(', ')}`);
              
              // Try each possible name pattern
              for (const tagName of namesToTry) {
                if (customElements.get(tagName) || window.componentModuleMap[tagName]) {
                  console.log(`Found valid component name: ${tagName}`);
                  await loadComponentByName(tagName, container);
                  return; // Exit once we find a working component
                }
              }
              
              // If we reach here, try special case mappings
              if (componentName === 'reports' || componentName === 'report') {
                await loadComponentByName('wa-report-dashboard', container);
              } else if (componentName === 'authorization') {
                console.log('Loading authorization component');
                try {
                  // Try loading the index.js first to ensure all components are registered
                  await import('/static/components/authorization/index.js')
                    .catch(e => console.warn('Error pre-loading authorization module:', e));
                  
                  // Try each possible tag name for the authorization component
                  const authTags = [
                    'wa-role-manager',
                    'okui-role-manager',
                    'okui-authorization-dashboard'
                  ];
                  
                  let loaded = false;
                  for (const tag of authTags) {
                    if (customElements.get(tag)) {
                      console.log(`Using registered authorization component: ${tag}`);
                      await loadComponentByName(tag, container);
                      loaded = true;
                      break;
                    }
                  }
                  
                  // If no components were found registered, try the original approach
                  if (!loaded) {
                    console.warn('No authorization components registered, using default fallback');
                    await loadComponentByName('wa-role-manager', container);
                  }
                } catch (authError) {
                  console.error('Error loading authorization component:', authError);
                  container.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                      <h3 style="color: #d32f2f;">Authorization Component Error</h3>
                      <p>${authError.message || 'Unknown error loading authorization component'}</p>
                      <p>Please try refreshing the page or contact support.</p>
                    </div>
                  `;
                }
              } else if (componentName === 'vector-search') {
                console.log('Loading vector-search component');
                try {
                  // Try loading the index.js first to ensure all components are registered
                  await import('/static/components/vector-search/index.js')
                    .catch(e => console.warn('Error pre-loading vector-search module:', e));
                  
                  // Try each possible tag name for the vector search component
                  const vectorSearchTags = [
                    'wa-semantic-search',
                    'okui-semantic-search',
                    'okui-vector-search-dashboard'
                  ];
                  
                  let loaded = false;
                  for (const tag of vectorSearchTags) {
                    if (customElements.get(tag)) {
                      console.log(`Using registered vector search component: ${tag}`);
                      await loadComponentByName(tag, container);
                      loaded = true;
                      break;
                    }
                  }
                  
                  // If no components were found registered, try the original approach
                  if (!loaded) {
                    console.warn('No vector search components registered, using default fallback');
                    await loadComponentByName('wa-semantic-search', container);
                  }
                } catch (vectorError) {
                  console.error('Error loading vector-search component:', vectorError);
                  container.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                      <h3 style="color: #d32f2f;">Vector Search Component Error</h3>
                      <p>${vectorError.message || 'Unknown error loading vector search component'}</p>
                      <p>Please try refreshing the page or contact support.</p>
                    </div>
                  `;
                }
              } else {
                // If no specific match, try the original pattern as a fallback
                await loadComponentByName(`okui-${componentName}-dashboard`, container);
              }
            } catch (error) {
              console.error("Error loading component from URL:", error);
              
              // Display a more helpful error message in the component container
              (() => {
                try {
                  const attemptedNames = namesToTry ? namesToTry.map(name => `<li>${name}</li>`).join('') : 'None specified';
                  
                  // Get registered custom elements safely
                  let registeredElements = 'None detected';
                  try {
                    registeredElements = Array.from(document.querySelectorAll('*'))
                      .map(el => el.tagName.toLowerCase())
                      .filter(name => name.includes('-'))
                      .filter((v, i, a) => a.indexOf(v) === i) // unique values
                      .map(name => `<li>${name}</li>`)
                      .join('') || 'None detected';
                  } catch (e) {
                    registeredElements = 'Error getting custom elements';
                  }
                  
                  // Get component mappings safely
                  let componentMappings = 'None detected';
                  try {
                    if (window.componentModuleMap) {
                      componentMappings = Object.keys(window.componentModuleMap)
                        .filter(key => key.startsWith('okui-') || key.startsWith('wa-'))
                        .map(name => `<li>${name}</li>`)
                        .join('') || 'None detected';
                    }
                  } catch (e) {
                    componentMappings = 'Error getting component mappings';
                  }
                  
                  container.innerHTML = `
                    <div style="padding: 40px; border: 1px solid #f44336; margin: 20px; border-radius: 4px; background-color: #ffebee;">
                      <h3 style="color: #d32f2f; margin-top: 0;">Component Loading Error</h3>
                      <p>Failed to load component <code>okui-${componentName}-dashboard</code></p>
                      <details>
                        <summary>Technical Details</summary>
                        <pre style="overflow: auto; background: #f8f8f8; padding: 10px;">${error.message || 'Unknown error'}</pre>
                        <p>Attempted component names:</p>
                        <ul style="font-family: monospace;">
                          ${attemptedNames}
                        </ul>
                        <p>Available custom elements in registry:</p>
                        <ul style="font-family: monospace;">
                          ${registeredElements}
                        </ul>
                        <p>Available component mappings:</p>
                        <ul style="font-family: monospace;">
                          ${componentMappings}
                        </ul>
                      </details>
                      <p>Try these troubleshooting steps:</p>
                      <ol>
                        <li>Check that the component name in URL matches a defined component</li>
                        <li>Check browser console for additional error details</li>
                        <li>Verify that all required scripts are properly loaded</li>
                      </ol>
                    </div>
                  `;
                } catch (displayError) {
                  // Last resort fallback if error display fails
                  console.error("Error displaying error details:", displayError);
                  container.innerHTML = `
                    <div style="padding: 40px; border: 1px solid #f44336; margin: 20px; border-radius: 4px; background-color: #ffebee;">
                      <h3 style="color: #d32f2f; margin-top: 0;">Component Loading Error</h3>
                      <p>Failed to load component for "${componentName}"</p>
                      <p>Error: ${error.message || 'Unknown error'}</p>
                    </div>
                  `;
                }
              })();
            }
          }
        }
        return;
      }
      
      const componentTag = placeholder.dataset.component;
      console.log('Loading component from placeholder:', componentTag);
      
      try {
        await ensureComponentLoaded(componentTag);
        
        // Create the component
        const component = document.createElement(componentTag);
        
        // Add any attributes from the data- attributes
        Object.keys(placeholder.dataset).forEach(key => {
          if (key !== 'component') {
            component.setAttribute(key, placeholder.dataset[key]);
          }
        });
        
        // Replace the placeholder with the actual component
        if (placeholder.parentNode) {
          placeholder.parentNode.replaceChild(component, placeholder);
          console.log('Component successfully rendered:', componentTag);
        } else {
          console.error('Cannot replace component - placeholder has no parent');
          // Try to just insert the component at the component container
          const container = document.getElementById('component-container');
          if (container) {
            container.innerHTML = '';
            container.appendChild(component);
            console.log('Component inserted into container:', componentTag);
          } else {
            console.error('Could not find component container to insert component');
          }
        }
      } catch (error) {
        console.error('Error loading component:', error);
        if (placeholder) {
          placeholder.innerHTML = `
            <div style="padding: 40px; text-align: center; color: #666;">
              <div style="color: #f44336; font-weight: bold; margin-bottom: 10px;">
                Error loading component
              </div>
              <div>${error.message || 'Unknown error'}</div>
            </div>
          `;
        }
      }
    };
    
    // Function to safely load the component
    const loadComponent = async () => {
      // First check if DOM is already loaded, if not wait for it
      if (document.readyState !== 'loading') {
        await initializeComponent();
      } else {
        document.addEventListener('DOMContentLoaded', initializeComponent);
      }
    };
    
    // Call loadComponent after both functions are defined
    loadComponent();
  </script>
  
  <script>
    // Handle script loading errors
    const scriptElements = document.querySelectorAll('script[type="module"]');
    for (const script of scriptElements) {
      script.addEventListener('error', (event) => {
        console.error('Error loading script:', script.src, event);
      });
    }
    
    // Initialize theme handling
    document.addEventListener('DOMContentLoaded', () => {
      // Check for stored theme preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const storedTheme = localStorage.getItem('wa-theme');
      
      if (storedTheme === 'dark' || (!storedTheme && prefersDark)) {
        document.documentElement.classList.add('sl-theme-dark');
        document.documentElement.classList.remove('sl-theme-light');
      } else {
        document.documentElement.classList.add('sl-theme-light');
        document.documentElement.classList.remove('sl-theme-dark');
      }
      
      // Listen for theme changes
      document.addEventListener('wa:theme-change', (e) => {
        localStorage.setItem('wa-theme', e.detail.theme);
        
        if (e.detail.theme === 'dark') {
          document.documentElement.classList.add('sl-theme-dark');
          document.documentElement.classList.remove('sl-theme-light');
        } else {
          document.documentElement.classList.add('sl-theme-light');
          document.documentElement.classList.remove('sl-theme-dark');
        }
      });
      
      // Debug component loading
      console.log('Registered custom elements:', 
        Array.from(document.querySelectorAll('*'))
          .map(el => el.tagName)
          .filter((tag, i, arr) => arr.indexOf(tag) === i) // Get unique tags
          .filter(tag => tag.toLowerCase().includes('okui-') || tag.toLowerCase().includes('wa-'))
          .sort()
      );
      
      // Log component container state
      const componentContainer = document.getElementById('component-container');
      console.log('Component container:', componentContainer);
      console.log('Component container children:', componentContainer.children);
      
      // Add fallback for components that might not be registered yet
      if (componentContainer.children.length === 1) {
        const targetComponent = componentContainer.children[0];
        if (targetComponent.tagName.toLowerCase().startsWith('okui-') && 
            !targetComponent.shadowRoot && 
            !targetComponent.innerHTML) {
          console.log('Component appears to be unregistered:', targetComponent.tagName);
          
          // Check if we need to load the component on demand
          const componentName = targetComponent.tagName.toLowerCase();
          
          if (componentName === 'okui-workflow-dashboard') {
            import('/static/components/workflows/okui-workflow-dashboard.js')
              .then(() => console.log('Successfully loaded workflow dashboard'))
              .catch(err => console.error('Failed to load component:', err));
          } else if (componentName === 'okui-workflow-designer') {
            import('/static/components/workflows/okui-workflow-designer.js')
              .then(() => console.log('Successfully loaded workflow designer'))
              .catch(err => console.error('Failed to load component:', err));
          } else if (componentName === 'okui-workflow-execution-detail') {
            import('/static/components/workflows/okui-workflow-execution-detail.js')
              .then(() => console.log('Successfully loaded workflow execution detail'))
              .catch(err => console.error('Failed to load component:', err));
          } else if (componentName === 'okui-workflow-simulator') {
            import('/static/components/workflows/okui-workflow-simulator.js')
              .then(() => console.log('Successfully loaded workflow simulator'))
              .catch(err => console.error('Failed to load component:', err));
          }
          
          // Add a message to indicate loading
          const loadingMessage = document.createElement('div');
          loadingMessage.textContent = 'Loading component...';
          loadingMessage.style.padding = '40px';
          loadingMessage.style.textAlign = 'center';
          loadingMessage.style.color = '#666';
          componentContainer.appendChild(loadingMessage);
        }
      }
    });
  </script>
{% endblock %}